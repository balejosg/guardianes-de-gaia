name: ðŸŒ End-to-End API Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - '*.js'
      - 'package.json'
      - '.github/workflows/e2e-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - '*.js'
      - 'package.json'
      - '.github/workflows/e2e-tests.yml'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'E2E Test Suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - functional-api
          - user-journey
          - simple-journey
          - visual-journey

env:
  NODE_VERSION: '18'
  BACKEND_PORT: 8080
  TEST_TIMEOUT: 300000  # 5 minutes

jobs:
  # ============================================
  # Consolidated E2E Test Execution with Backend Setup
  # ============================================
  e2e-tests:
    name: ðŸ§ª E2E Tests (${{ matrix.test-file }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
    
    strategy:
      matrix:
        test-file:
          - functional-api-test.js
          - user-journey-test.js
          - simple-journey-test.js
          - visual-journey-test.js
      fail-fast: false
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ðŸ³ Pull Pre-built Backend Image
        run: |
          echo "ðŸš€ Using optimized pre-built Docker image for ultra-fast startup..."
          # Pull the latest pre-built backend image from GHCR
          docker pull ghcr.io/${{ github.repository_owner }}/guardianes-backend:main
          docker images | grep guardianes-backend
          echo "âœ… Pre-built backend image ready for instant deployment"
      
      - name: ðŸš€ Start Backend Container (Ultra-Fast)
        env:
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        run: |
          echo "ðŸ³ Starting optimized backend container with instant H2 database..."
          
          # Use docker-compose.ci.yml for optimized container deployment
          docker compose -f docker-compose.ci.yml up -d backend-test
          
          # Get container ID for monitoring
          CONTAINER_ID=$(docker compose -f docker-compose.ci.yml ps -q backend-test)
          echo "CONTAINER_ID=$CONTAINER_ID" >> $GITHUB_ENV
          echo "âœ… Backend container started: $CONTAINER_ID"
          echo "ðŸ¥ H2 Console available at: http://localhost:${{ env.BACKEND_PORT }}/h2-console"
          
          # Show container status
          docker compose -f docker-compose.ci.yml ps
          echo "ðŸš€ Container startup initiated at $(date)"
      
      - name: â³ Wait for Container Health (Docker Native)
        id: health-check
        run: |
          echo "ðŸ¥ Waiting for Docker container healthcheck to pass..."
          echo "Container ID: $CONTAINER_ID"
          
          # Use Docker's native healthcheck with optimized timing (12 attempts * 5s = 1 minute max)
          for i in {1..12}; do
            # Check container status and health
            CONTAINER_STATUS=$(docker inspect --format='{{.State.Status}}' $CONTAINER_ID)
            HEALTH_STATUS=$(docker inspect --format='{{.State.Health.Status}}' $CONTAINER_ID 2>/dev/null || echo "none")
            
            echo "ðŸ” Container Status: $CONTAINER_STATUS, Health: $HEALTH_STATUS"
            
            if [ "$CONTAINER_STATUS" != "running" ]; then
              echo "âŒ Container stopped unexpectedly"
              docker compose -f docker-compose.ci.yml logs backend-test
              exit 1
            fi
            
            if [ "$HEALTH_STATUS" = "healthy" ] || curl -f -s http://localhost:${{ env.BACKEND_PORT }}/actuator/health; then
              echo "âœ… Backend container is healthy after ${i} attempts!"
              echo "ready=true" >> $GITHUB_OUTPUT
              
              # Display container and H2 database info
              echo "ðŸ“Š Container Health Status:"
              docker inspect --format='{{.State.Health}}' $CONTAINER_ID
              echo "ðŸ“Š H2 Database Status:"
              curl -s http://localhost:${{ env.BACKEND_PORT }}/actuator/health | jq '.' || echo "Health endpoint responded successfully"
              
              # Load test data now that backend is ready
              echo "ðŸ”„ Loading E2E test data..."
              curl -f -u ci:ci_test -X POST http://localhost:${{ env.BACKEND_PORT }}/api/test/load-data || echo "âš ï¸ Test data loading failed but continuing..."
              echo "âœ… E2E test data loaded"
              
              exit 0
            fi
            echo "â³ Attempt $i/12: Container not healthy yet, waiting 5 seconds..."
            sleep 5
          done
          
          echo "âŒ Backend container failed to become healthy within 1-minute timeout"
          docker compose -f docker-compose.ci.yml logs backend-test
          exit 1
      
      - name: ðŸ“¦ Install Node Dependencies (Robust)
        run: |
          echo "ðŸ”§ Installing Node.js dependencies with clean install..."
          
          # Clear npm cache to avoid corruption issues
          npm cache clean --force
          
          # Use npm ci for deterministic, reliable, faster installs for CI environments
          npm ci
          
          # Verify critical dependencies are properly installed
          echo "ðŸ” Verifying dependency installation..."
          npm list puppeteer || (echo "âŒ Puppeteer not found, installing..." && npm install puppeteer)
          
          # Specifically verify lines-and-columns module is properly installed
          if [ ! -f "node_modules/lines-and-columns/build/index.js" ]; then
            echo "âŒ lines-and-columns module incomplete, reinstalling..."
            npm uninstall lines-and-columns
            npm install lines-and-columns
          fi
          
          # Final verification of all dependencies
          echo "âœ… Node.js dependencies installed and verified successfully"
          npm list --depth=0
          
          # Debug dependency paths (for troubleshooting)
          echo "ðŸ” Debug: Node.js module resolution paths:"
          node -e "console.log(require.resolve.paths('puppeteer'))"
          echo "ðŸ” Debug: lines-and-columns module path:"
          node -e "console.log(require.resolve('lines-and-columns'))" || echo "âš ï¸ lines-and-columns not found in require.resolve"
      
      - name: ðŸ§ª Run E2E Test - ${{ matrix.test-file }}
        id: test-execution
        env:
          NODE_OPTIONS: '--max-old-space-size=4096'
          CI: 'true'
          BACKEND_URL: 'http://localhost:${{ env.BACKEND_PORT }}'
          SCREENSHOTS_ENABLED: 'true'
          LOG_LEVEL: 'info'
        run: |
          echo "Running E2E test: ${{ matrix.test-file }}"
          
          # Create required directories
          npm run pretest
          
          # Extract test name for targeted execution
          TEST_NAME=$(echo "${{ matrix.test-file }}" | sed 's/-test\.js$//' | sed 's/\.js$//')
          
          # Map test names to correct npm script names
          case "$TEST_NAME" in
            "functional-api")
              SCRIPT_NAME="functional"
              ;;
            "user-journey")
              SCRIPT_NAME="user-journey"
              ;;
            "simple-journey")
              SCRIPT_NAME="simple"
              ;;
            "visual-journey")
              SCRIPT_NAME="visual"
              ;;
            *)
              SCRIPT_NAME="$TEST_NAME"
              ;;
          esac
          
          echo "Running test script: npm run test:$SCRIPT_NAME"
          
          # Run the specific test using the test runner
          timeout ${{ env.TEST_TIMEOUT }} npm run test:$SCRIPT_NAME || {
            echo "Test failed or timed out"
            exit 1
          }
        continue-on-error: false
      
      - name: ðŸ“¸ Upload Screenshots & Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results-${{ matrix.test-file }}-${{ github.run_id }}
          path: |
            screenshots/
            e2e-test-results.json
            *.png
            logs/
          retention-days: 7
      
      - name: ðŸ“‹ Collect Logs
        if: failure()
        run: |
          echo "Collecting logs for debugging..."
          mkdir -p logs
          
          # Backend logs and metrics
          curl -s -u admin:e2e_test_password http://localhost:${{ env.BACKEND_PORT }}/actuator/loggers > logs/backend-loggers.json || echo "Could not get backend loggers"
          curl -s -u admin:e2e_test_password http://localhost:${{ env.BACKEND_PORT }}/actuator/metrics > logs/backend-metrics.json || echo "Could not get backend metrics"
          curl -s -u admin:e2e_test_password http://localhost:${{ env.BACKEND_PORT }}/actuator/health > logs/backend-health.json || echo "Could not get backend health"
          
          # H2 database info (if accessible)
          echo "H2 Database URL: jdbc:h2:mem:e2e_testdb;MODE=MySQL" > logs/h2-info.txt
          echo "H2 Console: http://localhost:${{ env.BACKEND_PORT }}/h2-console" >> logs/h2-info.txt
          
          # Process information
          ps aux | grep java > logs/java-processes.txt || echo "Could not get java processes"
      
      - name: ðŸ“¤ Upload Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs-${{ matrix.test-file }}-${{ github.run_id }}
          path: logs/
          retention-days: 3
      
      - name: ðŸ›‘ Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up Docker containers and resources..."
          
          # Stop and remove Docker containers
          docker compose -f docker-compose.ci.yml down || echo "No containers to stop"
          
          # Remove any dangling containers
          docker container prune -f || echo "No containers to prune"
          
          # Show final Docker status
          docker ps -a | grep guardianes || echo "No guardianes containers remaining"
          
          echo "âœ… Docker cleanup completed - H2 in-memory database automatically disposed"

  # ============================================
  # E2E Test Summary
  # ============================================
  e2e-summary:
    name: ðŸ“‹ E2E Test Summary
    runs-on: ubuntu-latest
    needs: [e2e-tests]
    if: always()
    permissions:
      contents: read
    
    steps:
      - name: ðŸ“Š Generate E2E Test Summary
        run: |
          echo "## ðŸŒ End-to-End Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ—„ï¸ Database Configuration:" >> $GITHUB_STEP_SUMMARY
          echo "- **Database**: H2 In-Memory (MySQL Compatibility Mode)" >> $GITHUB_STEP_SUMMARY
          echo "- **Profile**: e2e" >> $GITHUB_STEP_SUMMARY
          echo "- **External Services**: None (fully self-contained)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Test Execution Status:" >> $GITHUB_STEP_SUMMARY
          echo "- **E2E Tests**: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.e2e-tests.result }}" == "success" ]]; then
            echo "âœ… **All E2E tests passed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The complete user journey validation has been verified using H2 in-memory database." >> $GITHUB_STEP_SUMMARY
            echo "- Fast execution with zero external dependencies" >> $GITHUB_STEP_SUMMARY
            echo "- MySQL compatibility mode ensures production-like behavior" >> $GITHUB_STEP_SUMMARY
            echo "- Consolidated architecture with backend setup and tests in same runner" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Some E2E tests failed.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the test logs and screenshots for debugging." >> $GITHUB_STEP_SUMMARY
            echo "H2 Console was available at: http://localhost:8080/h2-console" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¸ Artifacts Generated:" >> $GITHUB_STEP_SUMMARY
          echo "- Screenshots from all test runs" >> $GITHUB_STEP_SUMMARY
          echo "- Debug logs and H2 database information" >> $GITHUB_STEP_SUMMARY
          echo "- Backend health checks and metrics" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ“Š E2E Pipeline Status
        if: always()
        run: |
          echo "E2E test pipeline completed. Results:"
          echo "- E2E Tests (consolidated): ${{ needs.e2e-tests.result }}"
          echo "Check GitHub Actions for detailed test reports and screenshots."