name: ðŸŒ End-to-End API Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - '*.js'
      - 'package.json'
      - '.github/workflows/e2e-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - '*.js'
      - 'package.json'
      - '.github/workflows/e2e-tests.yml'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'E2E Test Suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - functional-api
          - user-journey
          - simple-journey
          - visual-journey

env:
  NODE_VERSION: '18'
  BACKEND_PORT: 8080
  TEST_TIMEOUT: 300000  # 5 minutes

jobs:
  # ============================================
  # Consolidated E2E Test Execution with Backend Setup
  # ============================================
  e2e-tests:
    name: ðŸ§ª E2E Tests (${{ matrix.test-file }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
    
    strategy:
      matrix:
        test-file:
          - functional-api-test.js
          - user-journey-test.js
          - simple-journey-test.js
          - visual-journey-test.js
      fail-fast: false
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ðŸ—ï¸ Build Backend JAR
        working-directory: ./backend
        run: |
          echo "Building backend JAR for E2E testing..."
          # Build JAR directly for faster startup - skipping quality checks
          mvn clean package -DskipTests -Dspotless.apply.skip=true -Dcheckstyle.skip=true -Dspotbugs.skip=true -Ddependency-check.skip=true
          ls -la target/*.jar
          echo "âœ… Backend JAR built successfully"
      
      - name: ðŸš€ Start Backend Service (H2 In-Memory)
        working-directory: ./backend
        env:
          SPRING_PROFILES_ACTIVE: e2e
          SERVER_PORT: ${{ env.BACKEND_PORT }}
          JAVA_OPTS: '-Xmx768m -Xms768m -XX:TieredStopAtLevel=1 -XX:+UseSerialGC -Djava.awt.headless=true -XX:+UnlockExperimentalVMOptions -XX:+UseJVMCICompiler -XX:+EagerJVMCI -Dspring.backgroundpreinitializer.ignore=true -Dspring.output.ansi.enabled=NEVER'
        run: |
          echo "Starting backend JAR with H2 in-memory database for E2E testing..."
          echo "JVM Options: $JAVA_OPTS"
          
          # Find the JAR file
          JAR_FILE=$(ls target/guardianes-backend-*.jar | head -1)
          echo "Using JAR: $JAR_FILE"
          
          # Start backend JAR with ultra-optimized CI profile
          java $JAVA_OPTS -Dspring.profiles.active=ci -jar "$JAR_FILE" &
          BACKEND_PID=$!
          echo "BACKEND_PID=$BACKEND_PID" >> $GITHUB_ENV
          echo "Backend JAR started with PID: $BACKEND_PID at $(date)"
          echo "H2 Console will be available at: http://localhost:${{ env.BACKEND_PORT }}/h2-console"
          
          # Give it a moment to start
          sleep 5
          echo "Initial JAR startup phase completed"
      
      - name: â³ Wait for Backend Health
        id: health-check
        run: |
          echo "Waiting for H2 in-memory backend to be ready..."
          echo "Backend PID: $BACKEND_PID"
          
          # Realistic timeout for CI JAR startup (24 attempts * 5s = 2 minutes max)
          for i in {1..24}; do
            # Check if backend process is still running
            if ! kill -0 $BACKEND_PID 2>/dev/null; then
              echo "âŒ Backend process died unexpectedly"
              exit 1
            fi
            
            if curl -f -s http://localhost:${{ env.BACKEND_PORT }}/actuator/health; then
              echo "âœ… Backend is ready after ${i} attempts!"
              
              # Display H2 database info
              echo "ðŸ“Š H2 Database Status:"
              curl -s http://localhost:${{ env.BACKEND_PORT }}/actuator/health | jq '.' || echo "Health endpoint responded successfully"
              
              # Load test data now that backend is ready
              echo "ðŸ”„ Loading E2E test data..."
              curl -f -X POST http://localhost:${{ env.BACKEND_PORT }}/api/test/load-data || echo "âš ï¸ Test data loading failed but continuing..."
              echo "âœ… E2E test data loaded"
              
              break
            fi
            echo "â³ Attempt $i/24: Backend not ready yet, waiting 5 seconds..."
            sleep 5
          done
          
          # Final verification
          if ! curl -f -s http://localhost:${{ env.BACKEND_PORT }}/actuator/health; then
            echo "âŒ Backend JAR failed to start within 2-minute timeout"
            exit 1
          fi
      
      - name: ðŸ“¦ Install Node Dependencies
        run: |
          npm install
          # Install additional dependencies if needed
          npm list puppeteer || npm install puppeteer
      
      - name: ðŸ§ª Run E2E Test - ${{ matrix.test-file }}
        id: test-execution
        env:
          NODE_OPTIONS: '--max-old-space-size=4096'
          CI: 'true'
          BACKEND_URL: 'http://localhost:${{ env.BACKEND_PORT }}'
          SCREENSHOTS_ENABLED: 'true'
          LOG_LEVEL: 'info'
        run: |
          echo "Running E2E test: ${{ matrix.test-file }}"
          
          # Create required directories
          npm run pretest
          
          # Extract test name for targeted execution
          TEST_NAME=$(echo "${{ matrix.test-file }}" | sed 's/-test\.js$//' | sed 's/\.js$//')
          
          # Map test names to correct npm script names
          case "$TEST_NAME" in
            "functional-api")
              SCRIPT_NAME="functional"
              ;;
            "user-journey")
              SCRIPT_NAME="user-journey"
              ;;
            "simple-journey")
              SCRIPT_NAME="simple"
              ;;
            "visual-journey")
              SCRIPT_NAME="visual"
              ;;
            *)
              SCRIPT_NAME="$TEST_NAME"
              ;;
          esac
          
          echo "Running test script: npm run test:$SCRIPT_NAME"
          
          # Run the specific test using the test runner
          timeout ${{ env.TEST_TIMEOUT }} npm run test:$SCRIPT_NAME || {
            echo "Test failed or timed out"
            exit 1
          }
        continue-on-error: false
      
      - name: ðŸ“¸ Upload Screenshots & Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results-${{ matrix.test-file }}-${{ github.run_id }}
          path: |
            screenshots/
            e2e-test-results.json
            *.png
            logs/
          retention-days: 7
      
      - name: ðŸ“‹ Collect Logs
        if: failure()
        run: |
          echo "Collecting logs for debugging..."
          mkdir -p logs
          
          # Backend logs and metrics
          curl -s -u admin:e2e_test_password http://localhost:${{ env.BACKEND_PORT }}/actuator/loggers > logs/backend-loggers.json || echo "Could not get backend loggers"
          curl -s -u admin:e2e_test_password http://localhost:${{ env.BACKEND_PORT }}/actuator/metrics > logs/backend-metrics.json || echo "Could not get backend metrics"
          curl -s -u admin:e2e_test_password http://localhost:${{ env.BACKEND_PORT }}/actuator/health > logs/backend-health.json || echo "Could not get backend health"
          
          # H2 database info (if accessible)
          echo "H2 Database URL: jdbc:h2:mem:e2e_testdb;MODE=MySQL" > logs/h2-info.txt
          echo "H2 Console: http://localhost:${{ env.BACKEND_PORT }}/h2-console" >> logs/h2-info.txt
          
          # Process information
          ps aux | grep java > logs/java-processes.txt || echo "Could not get java processes"
      
      - name: ðŸ“¤ Upload Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs-${{ matrix.test-file }}-${{ github.run_id }}
          path: logs/
          retention-days: 3
      
      - name: ðŸ›‘ Cleanup
        if: always()
        run: |
          # Stop any running Spring Boot processes
          pkill -f "spring-boot:run" || echo "No Spring Boot processes to kill"
          
          # Clean up any remaining Java processes related to our tests
          pkill -f "guardianes-backend" || echo "No guardian backend processes to kill"
          
          echo "âœ… Cleanup completed - H2 in-memory database automatically disposed"

  # ============================================
  # E2E Test Summary
  # ============================================
  e2e-summary:
    name: ðŸ“‹ E2E Test Summary
    runs-on: ubuntu-latest
    needs: [e2e-tests]
    if: always()
    permissions:
      contents: read
    
    steps:
      - name: ðŸ“Š Generate E2E Test Summary
        run: |
          echo "## ðŸŒ End-to-End Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ—„ï¸ Database Configuration:" >> $GITHUB_STEP_SUMMARY
          echo "- **Database**: H2 In-Memory (MySQL Compatibility Mode)" >> $GITHUB_STEP_SUMMARY
          echo "- **Profile**: e2e" >> $GITHUB_STEP_SUMMARY
          echo "- **External Services**: None (fully self-contained)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Test Execution Status:" >> $GITHUB_STEP_SUMMARY
          echo "- **E2E Tests**: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.e2e-tests.result }}" == "success" ]]; then
            echo "âœ… **All E2E tests passed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The complete user journey validation has been verified using H2 in-memory database." >> $GITHUB_STEP_SUMMARY
            echo "- Fast execution with zero external dependencies" >> $GITHUB_STEP_SUMMARY
            echo "- MySQL compatibility mode ensures production-like behavior" >> $GITHUB_STEP_SUMMARY
            echo "- Consolidated architecture with backend setup and tests in same runner" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Some E2E tests failed.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the test logs and screenshots for debugging." >> $GITHUB_STEP_SUMMARY
            echo "H2 Console was available at: http://localhost:8080/h2-console" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¸ Artifacts Generated:" >> $GITHUB_STEP_SUMMARY
          echo "- Screenshots from all test runs" >> $GITHUB_STEP_SUMMARY
          echo "- Debug logs and H2 database information" >> $GITHUB_STEP_SUMMARY
          echo "- Backend health checks and metrics" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ“Š E2E Pipeline Status
        if: always()
        run: |
          echo "E2E test pipeline completed. Results:"
          echo "- E2E Tests (consolidated): ${{ needs.e2e-tests.result }}"
          echo "Check GitHub Actions for detailed test reports and screenshots."