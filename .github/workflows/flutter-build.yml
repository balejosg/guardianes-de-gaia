name: ðŸ”¨ Flutter APK Build

on:
  push:
    branches: [main, develop]
    paths:
      - 'mobile/**'
      - '.github/workflows/flutter-build.yml'
  pull_request:
    branches: [main]
    paths:
      - 'mobile/**'
  workflow_dispatch:
    inputs:
      build_mode:
        description: 'Build mode'
        required: false
        default: 'debug'
        type: choice
        options:
          - debug
          - release

env:
  FLUTTER_VERSION: '3.19.6'
  JAVA_VERSION: '17'

jobs:
  build-apk:
    name: ðŸ“± Build Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 1
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
      
      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
          channel: 'stable'
      
      - name: ðŸ§¹ Clean previous build artifacts
        working-directory: ./mobile/guardianes_mobile
        run: |
          echo "ðŸ§¹ Cleaning Flutter build cache and temporary files..."
          flutter clean
          
          # Remove problematic directories that cause permission issues
          rm -rf linux/flutter/ephemeral || true
          rm -rf macos/Flutter/ephemeral || true
          rm -rf ios/Flutter/ephemeral || true
          rm -rf build || true
          
          echo "âœ… Cleanup completed"
      
      - name: ðŸ“¦ Get Dependencies
        working-directory: ./mobile/guardianes_mobile
        run: |
          echo "ðŸ“¦ Getting Flutter dependencies..."
          flutter pub get
          echo "âœ… Dependencies retrieved"
      
      - name: ðŸ”§ Generate Code
        working-directory: ./mobile/guardianes_mobile
        run: |
          echo "ðŸ”§ Generating code with build_runner..."
          dart run build_runner build --delete-conflicting-outputs
          echo "âœ… Code generation completed"
      
      - name: ðŸ”§ Configure Android Signing
        working-directory: ./mobile/guardianes_mobile/android
        run: |
          echo "ðŸ”§ Configuring Android debug signing..."
          
          # Create .android directory if it doesn't exist
          mkdir -p ~/.android
          
          # Create debug keystore if it doesn't exist
          if [ ! -f ~/.android/debug.keystore ]; then
            echo "Creating debug keystore..."
            keytool -genkey -v \
              -keystore ~/.android/debug.keystore \
              -storepass android \
              -alias androiddebugkey \
              -keypass android \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -dname "CN=Android Debug,O=Android,C=US" \
              -noprompt
          else
            echo "Debug keystore already exists"
          fi
          echo "âœ… Android signing configured"
      
      - name: ðŸ—ï¸ Build Android APK
        working-directory: ./mobile/guardianes_mobile
        env:
          BUILD_MODE: ${{ github.event.inputs.build_mode || 'debug' }}
        run: |
          echo "ðŸ—ï¸ Building Android APK in $BUILD_MODE mode..."
          
          if [ "$BUILD_MODE" = "release" ]; then
            flutter build apk --release --verbose
          else
            flutter build apk --debug --verbose
          fi
          
          # Verify APK was created
          if [ ! -d "build/app/outputs/flutter-apk/" ]; then
            echo "âŒ APK build failed - output directory not found"
            exit 1
          fi
          
          echo "âœ… APK build completed"
          ls -la build/app/outputs/flutter-apk/
      
      - name: ðŸ“¤ Upload APK Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: guardianes-mobile-${{ github.event.inputs.build_mode || 'debug' }}-${{ github.sha }}
          path: mobile/guardianes_mobile/build/app/outputs/flutter-apk/
          retention-days: 30
      
      - name: ðŸ“Š Build Summary
        working-directory: ./mobile/guardianes_mobile
        run: |
          echo "## ðŸ“± APK Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Mode:** ${{ github.event.inputs.build_mode || 'debug' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Flutter Version:** ${{ env.FLUTTER_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for apk in build/app/outputs/flutter-apk/*.apk; do
            if [ -f "$apk" ]; then
              SIZE=$(du -h "$apk" | cut -f1)
              FILENAME=$(basename "$apk")
              echo "- **$FILENAME**: $SIZE" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **APK build completed successfully!**" >> $GITHUB_STEP_SUMMARY

  test-apk:
    name: ðŸ§ª APK Integration Tests
    runs-on: ubuntu-latest
    needs: build-apk
    if: always() && needs.build-apk.result == 'success'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“± Download APK
        uses: actions/download-artifact@v4
        with:
          name: guardianes-mobile-${{ github.event.inputs.build_mode || 'debug' }}-${{ github.sha }}
          path: ./apk
      
      - name: ðŸ” Verify APK
        run: |
          echo "ðŸ” Verifying downloaded APK files..."
          ls -la ./apk/
          
          APK_COUNT=$(find ./apk -name "*.apk" | wc -l)
          echo "Found $APK_COUNT APK file(s)"
          
          if [ $APK_COUNT -eq 0 ]; then
            echo "âŒ No APK files found!"
            exit 1
          fi
          
          echo "âœ… APK verification completed"
          echo "## ðŸ” APK Verification" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **APK files verified successfully**" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸš€ Ready for Installation
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ Ready for Installation!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your Guardianes de Gaia APK is ready to install!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“² **Installation Instructions:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the APK from the artifacts section above" >> $GITHUB_STEP_SUMMARY
          echo "2. Enable 'Unknown Sources' in your Android device settings" >> $GITHUB_STEP_SUMMARY
          echo "3. Install the APK on your device" >> $GITHUB_STEP_SUMMARY