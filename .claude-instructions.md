# Instrucciones para Claude Code

## Reglas de Código

### Java/Spring Boot
1. SIEMPRE escribir test unitario ANTES del código (TDD)
2. Usar records para Value Objects inmutables
3. Aggregate Roots extienden de clase base AggregateRoot
4. Repositories son interfaces en el dominio
5. Application Services coordinan casos de uso
6. Controllers son thin, solo traducen HTTP a comandos
7. Eventos de dominio para comunicación entre contextos
8. TODA funcionalidad nueva debe tener Feature Toggle

### Feature Toggles
1. Usar Spring Boot + Togglz
2. Nomenclatura: `FEATURE_<CONTEXTO>_<FUNCIONALIDAD>`
3. Ejemplo: `FEATURE_BATTLE_SEASONAL_EVENTS`
4. Crear test con toggle ON y OFF
5. Documentar en cada toggle: owner, fecha esperada de removal
6. Configurar dashboard Togglz para cambios en runtime

### Monitoreo y Analytics
1. Instrumentar TODOS los endpoints con Micrometer
2. Eventos de negocio a Mixpanel/Amplitude
3. Logs estructurados con correlation ID
4. Health checks custom por bounded context
5. Métricas de dominio (no solo técnicas)
6. Dashboard en Grafana desde día 1

### Docker
1. Multi-stage builds para optimizar tamaño
2. Non-root user para seguridad
3. Healthchecks en todos los servicios
4. docker-compose.yml para desarrollo local
5. Networks separadas por contexto
6. Volúmenes para persistencia

### Nombrado DDD
- Value Objects: GuardianId, GuardianName, StepCount
- Aggregates: Guardian, Route, Battle
- Services: GuardianCreator, RouteCalculator
- Events: GuardianCreated, RouteCompleted
- Metrics: GuardianMetrics, BattleMetrics
- Toggles: GuardianFeatures, BattleFeatures

### Tests con Feature Toggles
```java
@Test
@TogglzRule.enable(FEATURE_BATTLE_COMBO_SYSTEM)
void should_calculate_combo_when_feature_enabled() {
    // test con feature activo
}

@Test  
@TogglzRule.disable(FEATURE_BATTLE_COMBO_SYSTEM)
void should_ignore_combo_when_feature_disabled() {
    // test con feature inactivo
}
```

### Flutter
- BLoC pattern estricto: Events, States, Bloc
- Un archivo por clase
- Widgets const cuando sea posible
- Separar lógica de presentación
- Firebase Analytics para eventos
- Sentry para crash reporting
- Performance monitoring integrado
- Feature flags con Firebase Remote Config

### Flujo de Trabajo TDD/BDD

- Escribir feature Cucumber (si aplica)
- Escribir test unitario que falle
- Implementar código mínimo para pasar
- Refactorizar manteniendo tests verdes
- Añadir métricas del uso-
- Commit con mensaje descriptivo-
- Verificar que Docker build funciona

### Estructura de Commits

- feat: Nueva funcionalidad
- fix: Corrección de bugs
- test: Añadir tests
- refactor: Refactorización
- docs: Documentación
- chore: Tareas de mantenimiento